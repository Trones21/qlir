migrate code from afterdata (after doing a slight cleanup)